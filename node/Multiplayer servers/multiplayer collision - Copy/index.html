<!DOCTYPE html>
<html>
  <body>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.js"></script>
    <script>
        var socket = io();

        socket.on('positions', function(msg) {
            playerData = msg
        });
    </script>
    <script>
        var grid = {
            'length' : 32,
            'width' : 32,
            'scale' : 15,
            'getValue' : function(x, y){
                return this.img[x][y]
            },
            'getPosValue' : function(x, y){
                return this.img[floor(y/this.scale)][floor(x/this.scale)]
            },
            'img' : ["11111111111111111111111111111111","10000000000100000000000000000001","10000000000100000000000000000001","10000000000000000000000000000001","10000000000000000000000000000001","10000000000000000000000000000001","10000000000000000000000000000001","10000000000100000000000000000001","10000000000100000000000000000001","10000000000100000000000000000001","10000000000100000000000000000001","10000000000111111100100011111111","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100000000001","10000000000100000000100000000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000000000000000010000001","10000000000000000000000010000001","10000000000000000000000010000001","10000000000000000000000010000001","10000000000100000000000010000001","10000000000100000000000010000001","11111111111111111111111111111111"]
        }
    </script>
    <script>
 
        var playerData = []
        var myname = "no name set";
        var mycolor = "#000000";

        var player = {
            'x' : 100,
            'y' : 100,
            'speed' : 2
        }

        function setup() {
            createCanvas(windowWidth*.95, windowHeight*.95);
            //createCanvas(500, 500);
            
            background(220);
            textAlign(CENTER, CENTER);
            // canvas.onselectstart = function () { return false; }   
            // canvas.style['-webkit-user-select'] = 'none';

            myname = prompt("Input your name:")
            mycolor = prompt("Input a color in #RRGGBB format:")

            setParams();
        }

        function setParams(){
            socket.emit('configured', {color: mycolor, name: myname})
        }

        function draw() {
            clear()
            resetButtons()
            getTouches()
            getKeyboard()
            parseInputs()
            push();
			translate(-player.x + width/2, -player.y + height/2)
			drawPlayers(playerData)
            drawPlayer();
            drawGridImg()
            pop();
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        function drawPlayers(players){
            players.forEach(player => {
                push()
                if(player.id.localeCompare(socket.id) == 0){
                    // fill(mycolor)
                    // translate(player.x, player.y)
                    // circle(0, 0, 10)
                    // textSize(10);
                    // text(myname, 0, -10);
                    // pop()
                }
                else{
                    fill(player.color)
                    translate(player.x, player.y)
                    circle(0, 0, 10)
                    textSize(10);
                    text(player.name, 0, -10);
                    pop()
                }
                
            })
        }

        var moved = false;

        function parseInputs(){
            moved = false;
            newPos = [player.x, player.y]
            if (buttons[2]) {
                newPos[0] -= player.speed;
                moved = true;
            }
            if (buttons[3]) {
                newPos[0] += player.speed;
                moved = true;
            }
            if(grid.getPosValue(newPos[0], player.y) == 0){
                player.x = newPos[0]
                player.y = newPos[1]
            }

            newPos = [player.x, player.y]
            if (buttons[0]) {
                newPos[1] -= player.speed;
                moved = true;
            }
            if (buttons[1]) {
                newPos[1] += player.speed;
                moved = true;
            }
            if(grid.getPosValue(player.x, newPos[1]) == 0){
                player.y = newPos[1]
            }
            if(moved){
                moved = false;
                socket.emit('moved', {x: player.x, y: player.y})
            }
        }
        
        function drawGridImg() {
            for(var i = 0; i < grid.length; i++){
                for(var j = 0; j < grid.width; j++){
                    if(grid.getValue(i, j) == '1'){
                        rect(j*grid.scale, i*grid.scale, grid.scale, grid.scale)
                    }
                }
            }
        }

        function drawPlayer(){
            push()
            fill(mycolor)
            // translate(player.x, player.y)
            // circle(0, 0, 10)
            // textSize(10);
            // text(myname, 0, -10);
            // pop()
            circle(player.x, player.y, 10)
            pop()
        }
        
        var buttons = [0,0,0,0]
        function resetButtons(){buttons = [0,0,0,0]}
        function getKeyboard(){
            if(keyIsDown(LEFT_ARROW)) buttons[2] = true
            if(keyIsDown(RIGHT_ARROW)) buttons[3] = true
            if(keyIsDown(UP_ARROW)) buttons[0] = true
            if(keyIsDown(DOWN_ARROW)) buttons[1] = true
        }

        function getTouches(){
            console.log(touches)
            console.log(windowWidth, windowHeight)
            for (var touch = 0; touch < touches.length; touch++) {
                ellipse(touches[touch].x, touches[touch].y, 50, 50);
                if(overlapsRect(windowWidth/2 - windowWidth/4, 0, windowWidth/2, windowHeight/4, touches[0].x, touches[0].y)){
                    console.log("up")
                    buttons[0] = true
                }
                if(overlapsRect(windowWidth/2 - windowWidth/4, windowHeight/2 + windowHeight/4, windowWidth/2, windowHeight/4, touches[0].x, touches[0].y)){
                    console.log("dn")
                    buttons[1] = true
                }
                if(overlapsRect(0, windowHeight/2 - windowHeight/4, windowWidth/2, windowHeight/4, touches[0].x, touches[0].y)){
                    console.log("l")
                    buttons[2] = true
                }
                if(overlapsRect(windowWidth/2 + windowWidth/4, windowHeight/2 - windowHeight/4, windowWidth/2, windowHeight/4, touches[0].x, touches[0].y)){
                    console.log("r")
                    buttons[3] = true
                }
            }            
        }

        function overlapsRect(x,y,w,h,x1,y1){
            console.log(x,y)
            if(x1 > x && x1 < x+w && y1 > y && y1 < y+h) return true; return false
        }

        function touchStarted(event) {
            rect(mouseX, mouseY, 5, 5);
            // prevent default
            event.preventDefault();
            event.stopPropagation();
            return false;
        }
    </script>
  </body>
</html>