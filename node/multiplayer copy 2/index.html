<!DOCTYPE html>
<html>
  <body>
    <ul id="messages"></ul>
    <!-- <form id="form" action="">
      <input id="input" autocomplete="off" /><button>Send</button>
    </form> -->
    <form id="form" onsubmit="return false">
        <input id="name" autocomplete="off" placeholder="new user"/>
        <input id="color" autocomplete="off" placeholder = "#000000"/>
        <button onclick="setParams()">Set</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.js"></script>
    <script>
        var socket = io();

        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var input = document.getElementById('input');

        socket.on('chat message', function(msg) {
            console.log("chat messaage")
            console.log(msg)
            var item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('positions', function(msg) {
            playerData = msg
        });
    </script>
    <script>
        var grid = {
            'length' : 32,
            'width' : 32,
            'size' : 15,
            'getValue' : function(x, y){
                return this.img[x][y]
            },
            'getPosValue' : function(x, y){
                return this.img[floor(y/this.size)][floor(x/this.size)]
            },
            'img' : ["11111111111111111111111111111111","10000000000100000000000000000001","10000000000100000000000000000001","10000000000000000000000000000001","10000000000000000000000000000001","10000000000000000000000000000001","10000000000000000000000000000001","10000000000100000000000000000001","10000000000100000000000000000001","10000000000100000000000000000001","10000000000100000000000000000001","10000000000111111100100011111111","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100000000001","10000000000100000000100000000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000100000000100010000001","10000000000000000000000010000001","10000000000000000000000010000001","10000000000000000000000010000001","10000000000000000000000010000001","10000000000100000000000010000001","10000000000100000000000010000001","11111111111111111111111111111111"]
        }
    </script>
    <script>
 
        var playerData = []
        var myname = "no name set";
        var mycolor = "#000000";

        var player = {
            'x' : 100,
            'y' : 100,
            'speed' : 2
        }

        function setup() {
            //createCanvas(windowWidth, windowHeight);
            createCanvas(500, 500);
            
            background(220);
            textAlign(CENTER, CENTER);
            canvas.onselectstart = function () { return false; }   
            canvas.style['-webkit-user-select'] = 'none';
        }

        function setParams(){
            myname = document.getElementById('name').value;
            mycolor = document.getElementById('color').value;
            console.log(`${myname}, ${mycolor}`)
            socket.emit('configured', {color: mycolor, name: myname})
        }

        function draw() {
            clear()
            getInputs()
            //parseTouches()
            push();
			translate(-player.x + width/2, -player.y + height/2)
			drawPlayers(playerData)
            drawGridImg()
            pop();
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        function drawPlayers(players){
            players.forEach(player => {
                push()
                if(player.id.localeCompare(socket.id) == 0){
                    fill(mycolor)
                    translate(player.x, player.y)
                    circle(0, 0, 10)
                    textSize(10);
                    text(myname, 0, -10);
                    pop()
                }
                else{
                    fill(player.color)
                    translate(player.x, player.y)
                    circle(0, 0, 10)
                    textSize(10);
                    text(player.name, 0, -10);
                    pop()
                }
                
            })
        }

        var moved = false;
        function getInputs(){
            moved = false;
            newPos = [player.x, player.y]
            if (keyIsDown(LEFT_ARROW)) {
                newPos[0] -= player.speed;
                moved = true;
            }
            if (keyIsDown(RIGHT_ARROW)) {
                newPos[0] += player.speed;
                moved = true;
            }
            if(grid.getPosValue(newPos[0], player.y) == 0){
                player.x = newPos[0]
                player.y = newPos[1]
            }

            newPos = [player.x, player.y]
            if (keyIsDown(UP_ARROW)) {
                newPos[1] -= player.speed;
                moved = true;
            }
            if (keyIsDown(DOWN_ARROW)) {
                newPos[1] += player.speed;
                moved = true;
            }
            if(grid.getPosValue(player.x, newPos[1]) == 0){
                player.y = newPos[1]
            }
            if(moved){
                moved = false;
                socket.emit('moved', {x: player.x, y: player.y})
            }
        }
        
        function drawGridImg() {
            for(var i = 0; i < grid.length; i++){
                for(var j = 0; j < grid.width; j++){
                    if(grid.getValue(i, j) == '1'){
                        rect(j*grid.size, i*grid.size, grid.size, grid.size)
                    }
                }
            }
        }

        function drawPlayer(){
            circle(player.x, player.y, 10)
        }
        
        function parseTouches(){
            console.log(touches)
            console.log(windowWidth, windowHeight)
            for (var touch = 0; touch < touches.length; touch++) {
                ellipse(touches[touch].x, touches[touch].y, 50, 50);
                if(overlapsRect(windowWidth/2 - windowWidth/4, 0, windowWidth/2, windowHeight/4, touches[0].x, touches[0].y)){
                    console.log("up")
                    y -= 5;
                    moved = true;
                }
                if(overlapsRect(windowWidth/2 - windowWidth/4, windowHeight/2 + windowHeight/4, windowWidth/2, windowHeight/4, touches[0].x, touches[0].y)){
                    console.log("dn")
                    y += 5;
                    moved = true;
                }
                if(overlapsRect(0, windowHeight/2 - windowHeight/4, windowWidth/2, windowHeight/4, touches[0].x, touches[0].y)){
                    console.log("l")
                    x -= 5;
                    moved = true;
                }
                if(overlapsRect(windowWidth/2 + windowWidth/4, windowHeight/2 - windowHeight/4, windowWidth/2, windowHeight/4, touches[0].x, touches[0].y)){
                    console.log("r")
                    x += 5;
                    moved = true;
                }
            }
            if (keyIsDown(LEFT_ARROW)) {
                x -= 5;
                moved = true;
            }

            if (keyIsDown(RIGHT_ARROW)) {
                x += 5;
                moved = true;
            }

            if (keyIsDown(UP_ARROW)) {
                y -= 5;
                moved = true;
            }

            if (keyIsDown(DOWN_ARROW)) {
                y += 5;
                moved = true;
            }
            if(moved){
                moved = false;
                socket.emit('moved', {x: x, y: y})
            }
            
        }

        function overlapsRect(x,y,w,h,x1,y1){
            console.log(x,y)
            if(x1 > x && x1 < x+w && y1 > y && y1 < y+h) return true; return false
        }

        function touchStarted(event) {
            rect(mouseX, mouseY, 5, 5);
            // prevent default
            event.preventDefault();
            event.stopPropagation();
            return false;
        }
    </script>
  </body>
</html>