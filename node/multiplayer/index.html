<!DOCTYPE html>
<html>
  <body>
    <ul id="messages"></ul>
    <!-- <form id="form" action="">
      <input id="input" autocomplete="off" /><button>Send</button>
    </form> -->
    <form id="form" onsubmit="return false">
        <input id="name" autocomplete="off" placeholder="new user"/>
        <input id="color" autocomplete="off" placeholder = "#000000"/>
        <button onclick="setParams()">Set</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.js"></script>
    <script>
        var socket = io();

        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var input = document.getElementById('input');

        // form.addEventListener('submit', function(e) {
        //     e.preventDefault();
        //     if (input.value) {
        //     socket.emit('chat message', input.value);
        //     input.value = '';
        //     }
        // });

        socket.on('chat message', function(msg) {
            console.log("chat messaage")
            console.log(msg)
            var item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('positions', function(msg) {
            // console.log("positions loading")
            // console.log(msg)
            playerData = msg
        });
    </script>
    <script>

        var playerData = []
        var myname = "no name set";
        var mycolor = "#000000";

        function setup() {
            //createCanvas(windowWidth, windowHeight);
            createCanvas(500, 500);
            
            background(220);
            textAlign(CENTER, CENTER);
        }

        function setParams(){
            myname = document.getElementById('name').value;
            mycolor = document.getElementById('color').value;
            console.log(`${myname}, ${mycolor}`)
            socket.emit('configured', {color: mycolor, name: myname})
        }

        function draw() {
            clear()
            drawPlayers(playerData)
            movePlayer()
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        function drawPlayers(players){
            players.forEach(player => {
                push()
                if(player.id.localeCompare(socket.id) == 0){
                    fill(mycolor)
                    translate(x, y)
                    circle(0, 0, 10)
                    textSize(10);
                    text(myname, 0, -10);
                    pop()
                }
                else{
                    fill(player.color)
                    translate(player.x, player.y)
                    circle(0, 0, 10)
                    textSize(10);
                    text(player.name, 0, -10);
                    pop()
                }
                
            })
        }

        var x = 0;
        var y = 0;
        var moved = false;
        function movePlayer(){
            if (keyIsDown(LEFT_ARROW)) {
                x -= 5;
                moved = true;
            }

            if (keyIsDown(RIGHT_ARROW)) {
                x += 5;
                moved = true;
            }

            if (keyIsDown(UP_ARROW)) {
                y -= 5;
                moved = true;
            }

            if (keyIsDown(DOWN_ARROW)) {
                y += 5;
                moved = true;
            }
            if(moved){
                moved = false;
                socket.emit('moved', {x: x, y: y})
            }

        }
    </script>
  </body>
</html>