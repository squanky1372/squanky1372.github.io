<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gobblet</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-size: 20px;
            /* Updated font size */
            font-family: Arial, sans-serif;
        }

        summary {
            font-size: inherit;
        }
    </style>
</head>

<body>
    <h2>Select a Gobblet Opponent</h2>
    <div id="output"></div>
    <div id="container"></div>
</body>

</html>

<script src="../aa_libraries/fj_games_library.js"></script>
<script>
    verifyHash()
    const response = fetch(`https://squanky.net/scores/getAllPlayers`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
    })
        .then(response => {
            if (!response.ok) {throw new Error(`HTTP error! Status: ${response.status}`);}
            return response.json()
        })
        .then(data => {
            console.log(data)
            createTable(data.players);
        })
        .catch(error => console.error(error));

    function createTable(data) {
        const container = document.getElementById('container');
        const table = document.createElement('table');
        table.border = '1';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '20px';
        table.style.width = '100%';

        const headerRow = document.createElement('tr');
        ['Username', 'Emoji', 'Hash'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            th.style.padding = '10px';
            th.style.border = '1px solid white';
            headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        data.forEach(item => {
            const row = document.createElement('tr');

            const usernameCell = document.createElement('td');
            usernameCell.textContent = item.username;
            usernameCell.style.padding = '10px';
            usernameCell.style.border = '1px solid white';

            const emojiCell = document.createElement('td');
            emojiCell.textContent = item.visuals?.emoji || '';
            if (!emojiCell.textContent) return
            emojiCell.style.padding = '10px';
            emojiCell.style.border = '1px solid white';

            const hashCell = document.createElement('td');
            hashCell.style.padding = '10px';
            hashCell.style.border = '1px solid white';

            if (item.hash.length > 8) {
                hashCell.textContent = "Outdated Account";
            } else {
                const button = document.createElement('button');
                button.textContent = "Challenge";
                button.onclick = () => issueChallenge(item);
                button.style.padding = "5px 10px";
                button.style.fontSize = "16px";
                button.style.cursor = "pointer";
                hashCell.appendChild(button);
            }

            row.appendChild(usernameCell);
            row.appendChild(emojiCell);
            row.appendChild(hashCell);

            table.appendChild(row);
        });

        container.appendChild(table);
    }


    function issueChallenge(player) {
        console.log("Challenging", player.username, "with hash", player.hash)

        var game = {
            state: 1,
            external: [[4, 4, 4], [4, 4, 4]],
            board: [
                [[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]],
                [[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]],
                [[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]],
                [[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]]
            ]
        }

        var gameid = generateUniqueHash()
        submitGameUpdate(game, hash, player.hash, gameid)

        window.location.href = `https://squanky1372.github.io/2025/games_dev/gobblet_2p.html?hash=${hash}&gameid=${gameid}`
    }

    function generateUniqueHash() {
        const base64Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';

        // 1. Seconds since Oct 13, 2000
        const startTime = new Date('2000-10-13T00:00:00Z').getTime();
        const now = Date.now();
        const seconds = Math.floor((now - startTime) / 1000);

        // 2. Convert to Base64
        let base64Seconds = btoa(String.fromCharCode(
            (seconds >> 24) & 0xFF,
            (seconds >> 16) & 0xFF,
            (seconds >> 8) & 0xFF,
            seconds & 0xFF
        ));

        // 3. Add 2 random base64 characters
        const random1 = base64Chars[Math.floor(Math.random() * 64)];
        const random2 = base64Chars[Math.floor(Math.random() * 64)];
        let result = base64Seconds + random1 + random2;

        // 4. Make it URL-safe
        result = result
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+/g, '~');

        return result;
    }

    function submitGameUpdate(game, p1, p2, gameid) {
    const response = fetch('https://squanky.net/scores/updateBoard', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ game, p1, p2, gameid })
    });
}

</script>